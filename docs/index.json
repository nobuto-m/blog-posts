
    
    
    
    
    
    
    [{"authors":null,"categories":null,"content":"Posting something, sometimes.\n","date":-62135596800,"expirydate":-62135596800,"kind":"term","lang":"en","lastmod":-62135596800,"objectID":"2525497d367e79493fd32b198b28f040","permalink":"","publishdate":"0001-01-01T00:00:00Z","relpermalink":"","section":"authors","summary":"Posting something, sometimes.","tags":null,"title":"Nobuto Murata","type":"authors"},{"authors":[],"categories":[],"content":" The “Secure Rollback Prevention” entry in the UEFI BIOS configuration The bottom line is that there is a new configuration called “AMD Secure Processor Rollback protection” on recent AMD systems in addition to “Secure Rollback Prevention” (BIOS rollback protection). If it’s enabled by a vendor, you cannot downgrade the UEFI BIOS revisions once you install a one with security vulnerability fixes.\nhttps://fwupd.github.io/libfwupdplugin/hsi.html#org.fwupd.hsi.Amd.RollbackProtection\nThis feature prevents an attacker from loading an older firmware onto the part after a security vulnerability has been fixed.\n[…]\nEnd users are not able to directly modify rollback protection, this is controlled by the manufacturer.\nPreviously I installed the revision 1.49 (R23ET73W) but it’s gone from Lenovo’s official page with the notice below. I’ve been annoyed by a symptom which is likely from a firmware so I wanted to try multiple revisions for bisecting, and also I thought I should downgrade it to the latest official revision as 1.40 (R23ET70W) since the withdrawal clearly indicates that there is something wrong with 1.49.\nThis BIOS version R23UJ73W is reported Lenovo cloud not working issue, hence it has been withdrawn from support site.\nFirst, I turned off Secure Rollback Prevention and tried downgrading it with fwupdmgr like the following. However, it failed to be applied with Secure Flash Authentication Failed when rebooted.\n$ fwupdmgr downgrade 0.\tCancel 1.\tb0fb0282929536060857f3bd5f80b319233340fd (Battery) 2.\t6fd62cb954242863ea4a184c560eebd729c76101 (Embedded Controller) 3.\t0d5d05911800242bb1f35287012cdcbd9b381148 (Prometheus) 4.\t3743975ad7f64f8d6575a9ae49fb3a8856fe186f (SKHynix HFS256GDE9X081N) 5.\td77c38c163257a2c2b0c0b921b185f481d9c1e0c (System Firmware) 6.\t6df01b2df47b1b08190f1acac54486deb0b4c645 (TPM) 7.\t362301da643102b9f38477387e2193e57abaa590 (UEFI dbx) Choose device [0-7]: 5 0.\tCancel 1.\t0.1.46 2.\t0.1.41 3.\t0.1.38 4.\t0.1.36 5.\t0.1.23 Choose release [0-5]: Next, I tried their ISO image r23uj70wd.iso, but no luck with another error.\nError\nThe system program file is not correct for this system.\nAlso, Windows failed to apply it so I became convinced it was impossible. However, I didn’t have a clear idea why at that point and bumped into a handy command in fwupdmgr.\n$ fwupdmgr security Host Security ID: HSI:1! (v1.9.16) HSI-1 ✔ BIOS firmware updates: Enabled ✔ Fused platform: Locked ✔ Supported CPU: Valid ✔ TPM empty PCRs: Valid ✔ TPM v2.0: Found ✔ UEFI bootservice variables: Locked ✔ UEFI platform key: Valid ✔ UEFI secure boot: Enabled HSI-2 ✔ SPI write protection: Enabled ✔ IOMMU: Enabled ✔ Platform debugging: Locked ✔ TPM PCR0 reconstruction: Valid ✘ BIOS rollback protection: Disabled HSI-3 ✔ SPI replay protection: Enabled ✔ CET Platform: Supported ✔ Pre-boot DMA protection: Enabled ✔ Suspend-to-idle: Enabled ✔ Suspend-to-ram: Disabled HSI-4 ✔ Processor rollback protection: Enabled ✔ Encrypted RAM: Encrypted ✔ SMAP: Enabled Runtime Suffix -! ✔ fwupd plugins: Untainted ✔ Linux kernel lockdown: Enabled ✔ Linux kernel: Untainted ✘ CET OS Support: Not supported ✘ Linux swap: Unencrypted This system has HSI runtime issues. » https://fwupd.github.io/hsi.html#hsi-runtime-suffix Host Security Events 2024-05-01 15:06:29: ✘ BIOS rollback protection changed: Enabled → Disabled As you can see, the BIOS rollback protection in the HSI-2 section is “Disabled” as intended. But Processor rollback protection in HSI-4 is “Enabled”. I found a commit suggesting that there was a system with the config disabled and it was able to be enabled when OS Optimized Defaults is turned on.\nhttps://github.com/fwupd/fwupd/commit/52d6c3cb78ab8ebfd432949995e5d4437569aaa6\nUpdate documentation to indicate that loading “OS Optimized Defaults”\nmay enable security processor rollback protection on Lenovo systems.\nI hoped that Processor rollback protection might be disabled by turning off OS Optimized Defaults instead.\nTried OS Optimized Defaults turned off but no luck $ fwupdmgr security Host Security ID: HSI:1! (v1.9.16) ... ✘ BIOS rollback protection: Disabled ... HSI-4 ✔ Processor rollback protection: Enabled ... Host Security Events 2024-05-02 03:24:45: ✘ Kernel lockdown disabled 2024-05-02 03:24:45: ✘ Secure Boot disabled 2024-05-02 03:24:45: ✘ Pre-boot DMA protection is disabled 2024-05-02 03:24:45: ✘ Encrypted RAM changed: Encrypted → Not supported Some configurations were overridden, but the Processor rollback protection stayed the same. It’s confirmed that it’s really impossible to downgrade the firmware with vulnerability fixes. I learned the hard way that there was a clear difference between “a vendor doesn’t support downgrading” and “it can’t be downgraded” as per the release notes.\nhttps://download.lenovo.com/pccbbs/mobiles/r23uj73wd.txt\nCHANGES IN THIS RELEASE\nVersion 1.49 (UEFI BIOS) 1.32 (ECP)\n[Important updates]\nNotice that BIOS can’t be downgraded to older BIOS version after upgrade to r23uj73w(1.49). [New functions or enhancements] …","date":1714706451,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1714706451,"objectID":"ce5493bb61321d5a1f3851a2d6708509","permalink":"https://nobuto-m.github.io/post/2024/no-you-can-t-downgrade-t14-gen-3-amd-s-uefi-bios-even-when-secure-rollback-prevention-is-turned-off/","publishdate":"2024-05-03T12:20:51+09:00","relpermalink":"/post/2024/no-you-can-t-downgrade-t14-gen-3-amd-s-uefi-bios-even-when-secure-rollback-prevention-is-turned-off/","section":"post","summary":"The “Secure Rollback Prevention” entry in the UEFI BIOS configuration The bottom line is that there is a new configuration called “AMD Secure Processor Rollback protection” on recent AMD systems in addition to “Secure Rollback Prevention” (BIOS rollback protection).","tags":["planet-ubuntu","ThinkPad T14 Gen 3 AMD"],"title":"No, you can't downgrade T14 Gen 3 AMD's UEFI BIOS even when Secure Rollback Prevention is turned off","type":"post"},{"authors":[],"categories":["Ubuntu"],"content":"There is a great set of articles in the Ubuntu Server guide about how to achieve an unattended installation of Ubuntu Server:\nAutomated Server installation Automated Server install quickstart Automated Server installer config file reference And I followed those to test my minimal autoinstall file as follows.\n#cloud-config autoinstall: version: 1 identity: hostname: ubuntu-server username: ubuntu # password=ubuntu password: \u0026#34;$6$exDY1mhS4KUYCE/2$zmn9ToZwTKLhCw.b4/b.ZRTIZM30JZ4QrOQ2aOXJ8yk96xpcCof0kxKwuX1kqLG/ygbJ1f8wxED22bTL4F46P0\u0026#34; ssh: install-server: yes # https://launchpad.net/bugs/1974483 allow-pw: no apt: geoip: false kernel: flavor: generic # or hwe It works flawlessly with the kvm command with:\n-append \u0026#39;autoinstall ds=nocloud-net;s=http://_gateway:3003/\u0026#39; as per the document. However, when it comes to a physical machine installation with the vanilla 22.04 LTS ISO, the installer just stopped at the initial language selection step.\nIn the end, it was a subtle difference. Without escaping the semicolon, the URL to the autoinstall file is ignored. One missing backslash cost me more than an hour. I provided feedback to the document and I hope it’s a time saver for somebody.\nThe semicolon must be escaped in GRUB ","date":1688282992,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1688282992,"objectID":"d6ce7ea91d3f16a2fc3e21bbc38d98dc","permalink":"https://nobuto-m.github.io/post/2023/ubuntu-server-autoinstall-with-a-physical-machine/","publishdate":"2023-07-02T16:29:52+09:00","relpermalink":"/post/2023/ubuntu-server-autoinstall-with-a-physical-machine/","section":"post","summary":"There is a great set of articles in the Ubuntu Server guide about how to achieve an unattended installation of Ubuntu Server:\nAutomated Server installation Automated Server install quickstart Automated Server installer config file reference And I followed those to test my minimal autoinstall file as follows.","tags":["planet-ubuntu"],"title":"Ubuntu Server autoinstall with a physical machine","type":"post"},{"authors":[],"categories":["Miscellaneous"],"content":"I intentionally spent the holidays by keeping myself busy with some technical stuff because I knew I would regret it if nothing had been done since there was no trip planned during the period. Those were not that creative, but to follow some tutorials, for example, where I didn’t have experience with or to address some day-to-day pains.\nImmediate wins Tailscale After moving to a new place last year, I lost the ability to assign a global IP address to my router. And it became impossible to access my testbed machine from outside with direct SSH forwarded by a router. There are multiple workarounds, including setting up a VPN like OpenVPN, Wireguard, etc., with a server on the Internet as a hub in the middle, or using a reverse tunnel. But it’s still nice if I can have some sort of direct and peer-to-peer connection.\nI tried both ZeroTier and Tailscale, which offer NAT traversal with VPN. I chose Tailscale in the end for simplicity, and I like their stance trying to explain everything happening inside and related technologies.\nNot every component of it is open-source, but it’s convenient since everything is well managed. There were some other options to set up an equivalent or compatible server though.\nTailscale eases a headache of NAT Not only for the remote access from my laptop on the go to the testbed machine (the arrow “A”), I enabled Tailscale for accessing my Grafana dashboard running inside a cloud instance (“B”) which is not necessary to be exposed to the Internet. I could just use SSH port forwarding or sshuttle but having a Wireguard-based connection without having a VPN endpoint exposed is like magic. As a bonus, I can reliably access a Raspberry-Pi running somewhere behind three NAT instances (“C”). I no longer have to worry about the SSH reverse tunnel for it and its retry logic I set up some time ago.\nExcalidraw As you can see above, the diagram was made with Excalidraw. It’s just amazing as turning my ugly diagram into a beautiful one. It’s getting more and more features these days. How wonderful it is.\nI’ve been using ASCIIFlow for some time since it was all text-based, which is convenient to have a diagram in Markdown text. However, I would use Excalidraw for most of the cases from now on for personal use.\nRandom stuff Setting up this blog I had some blogs so far on Blogger, Tumblr, and Medium, etc. But I wanted to have another one since Medium is getting annoying, especially when reading something on mobile. I believe this is the 5th blog. I’m using Hugo I’ve been interested in for some time, and I’ve found a lovely template, Wowchemy. I published the first post in two years, and I tried to fix the template’s corner-case issues. Then the author updated those on top of my some pull requests. Outstanding customizations are:\nshowing both the original published date and the modified/updated date yearly archive of the posts by defining a new taxonomy as “year” What took time to figure out was about the snap package of Hugo. It’s currently under strict confinement, but it doesn’t work with a template like Wowchemy with Go modules. There is a request to use classic confinement, but for now, I have alias hugo=/snap/hugo/current/bin/hugo as a workaround.\nI also tried Gihub Action for Hugo to automate the builds on the Github side. In the end, I prefer building it locally since it’s just a matter of seconds. I’ve also learned that prefers-color-scheme in CSS doesn’t work with Chrome/Chromium on Linux while working with Firefox.\nThinkpad battery Previously, the charge percentage dropped suddenly from 30-40% to nearly zero. I thought the battery was broken. But it was clearly written as a known issue in the TLP documentation so it became sane after setting it back to STOP_CHARGE_THRESH_BAT0=100.\nWake-on-LAN I haven’t used Wake-on-LAN for some time because I relied on a smart plug to power on my testbed machine remotely. Nowadays, I’m on the same network with the machine as I have fewer chances to go out. So waking it up with a terminal command is handy without opening a mobile app. Enabling WOL wasn’t as straightforward as it sounded. Googling told me that I had to specify the MAC address of the NIC explicitly for Netplan (indirectly for systemd-networkd). I wanted to know it earlier, so I opened a pull request to add the caveat in the doc.\nSquid shutdown took time I knew my laptop was taking time to shut down due to a LXD container running squid-deb-proxy. I thought it was inevitable to flush the content on memory to the disk, but it was actually configurable. Once setting shutdown_lifetime 3 seconds, the shutdown starts almost immediately now.\nLet’s encrypt wildcard certs and DNS-01 I wanted to have a proper TLS certificate for services running behind a firewall and not exposed to the Internet. So far, I only used HTTP-01 challenges for my public web servers. Now that wildcard certs with DNS-01 is available with Let’s encrypt, I migrated the nameservers for one of my domains to Cloudflare, which is in …","date":1609895342,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1609895342,"objectID":"434a62e75d3df5295b97bf8b9da4ecd5","permalink":"https://nobuto-m.github.io/post/2021/how-i-spent-year-end-holidays/","publishdate":"2021-01-06T10:09:02+09:00","relpermalink":"/post/2021/how-i-spent-year-end-holidays/","section":"post","summary":"I intentionally spent the holidays by keeping myself busy with some technical stuff because I knew I would regret it if nothing had been done since there was no trip planned during the period.","tags":[],"title":"How I spent year-end holidays","type":"post"},{"authors":[],"categories":["Ubuntu"],"content":" A custom and global shortcut key to mute / unmute yourself in Zoom or Google Meet Just like everyone else, 2020 was the year of having more and more video-conference calls. How many times did we struggle to find the meeting window during a call, and say “Sorry, I was on mute”? I tried to address the pain and ended up with the following setup.\nxdotool xdotool is a great automation tool for X, and it can search a window, activate it, and simulate keyboard input. That’s a perfect match for the use case here.\nHere is an example command for Google Meet.\n$ xdotool search --name \u0026#39;^Meet - .+ - Chromium$\u0026#39; \\ windowactivate --sync \\ key ctrl+d In the chained commands, it does:\nsearch windows named like Meet - \u0026lt;MEETING_ID\u0026gt; - Chromium activate the first window passed by the previous line and wait until it gets active (--sync) send a keystroke as Ctrl+D, which is the default shortcut in Meet By the way, my main browser is Firefox, but I have to use Chromium to join Meet calls since it tends to have less CPU utilization.\nYou can do something similar for Zoom with Alt+A.\n$ xdotool search --name \u0026#39;^Zoom Meeting$\u0026#39; \\ windowactivate --sync \\ key alt+a Microsoft Teams should work with Ctrl+Shift+M at least for the web version.\n$ xdotool search --name \u0026#39;^.* Microsoft Teams - Chromium$\u0026#39; \\ windowactivate --sync \\ key ctrl+shift+m GNOME keyboard shortcuts The commands above can be mapped to a shortcut key with GNOME.\nIt’s pretty simple, but some tricks may be required. As far as I see, gsd-media-keys will invoke a command when a shortcut key is pressed, not released. In my case, I use Super+Shift+A as the shortcut key, so Meet may recognize keys pressed as Super+Shift+A + Ctrl+D = Super+Shift+Ctrl+A+D which doesn’t trigger the mute/unmute behavior actually. Keys can be canceled with keyup, so the key command was turned into keyup shift+super+a in the end.\nAlso, I wanted to use the same shortcut key for multiple services, and I have the following line which tries Google Meet first, then Zoom if no Meet window is found. It should work most of the cases unless you join multiple meetings at the same time.\nsh -c \u0026#34; xdotool search --name \u0026#39;^Meet - .+ - Chromium$\u0026#39; windowactivate --sync keyup shift+super+a key ctrl+d || xdotool search --name \u0026#39;^.* Microsoft Teams - Chromium$\u0026#39; windowactivate --sync keyup shift+super+a key ctrl+shift+m || xdotool search --name \u0026#39;^Zoom Meeting$\u0026#39; windowactivate --sync keyup shift+super+a key alt+a \u0026#34; --clearmodifiers can be used to simplify the whole commands, but when I tried, it sometimes left the Super or Shift key pressed depending on the timing I released the key.\nHardware mute/unmute button Going further, I wanted to have a dedicated button to mute/unmute myself especially for some relaxed meetings where I don’t have to keep my hands on the keyboard all the time.\nBack in October, I bought a USB volume controller, which is recognized as “STMicroelectronics USB Volume Control” from the OS. It was around 15 USD.\nIt emits expected events as KEY_VOLUMEUP and KEY_VOLUMEDOWN with the dial, and KEY_MUTE when the knob is pressed.\nI created a “hwdb” file to remap the mute key to something else as follows in /etc/udev/hwdb.d/99-local-remap-usb-volume-control.hwdb.\n# STMicroelectronics USB Volume Control # Remap the click (Mute) to XF86Launch evdev:input:b0003v0483p572D* KEYBOARD_KEY_c00e2=prog4 Once the hardware database is updated with systemd-hwdb update and the device is unplugged and plugged again (if without udevadm commands), I was able to map Launch4(prog4) to the xdotool commands in GNOME successfully.\n","date":1609354193,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1682906864,"objectID":"b3456bd7371184b53578e836effa3a9c","permalink":"https://nobuto-m.github.io/post/2020/shortcut-key-to-mute-unmute-yourself-in-zoom-or-google-meet/","publishdate":"2020-12-31T03:49:53+09:00","relpermalink":"/post/2020/shortcut-key-to-mute-unmute-yourself-in-zoom-or-google-meet/","section":"post","summary":"A custom and global shortcut key to mute / unmute yourself in Zoom or Google Meet Just like everyone else, 2020 was the year of having more and more video-conference calls.","tags":["planet-ubuntu"],"title":"Shortcut key to mute/unmute yourself in Zoom, Google Meet, or Teams","type":"post"},{"authors":[],"categories":["Ubuntu"],"content":" EDIT: I have migrated one of my domains to Google Domains so I’m using protocol=googledomains these days. When I searched for a way to configure ddclient for No-IP.com, some pages mention protocol=dyndns2 with a custom URL. But actually, ddclient supports protocol=noip out of the box, so minimal steps would be something like:\n$ sudo apt install ddclient $ cat \u0026lt;\u0026lt;EOF | sudo tee /etc/ddclient.conf use=web ssl=yes protocol=noip login=\u0026lt;USERNAME\u0026gt; password=\u0026lt;PASSWORD\u0026gt; \u0026lt;YOUR_HOSTNAME\u0026gt; EOF And here we go.\n$ echo \u0026#39;run_daemon=\u0026#34;true\u0026#34;\u0026#39; | sudo tee -a /etc/default/ddclient $ sudo service ddclient restart $ journalctl -u ddclient.service ... systemd[1]: Started LSB: Update dynamic domain name service entries. ddclient[24631]: SUCCESS: updating MY_HOST.redirectme.net: good: IP address set to 118.X.Y.Z For more details, please refer to ddclient -help.\nThis post was originally published at https://medium.com/@nobuto_m/minimal-dynamic-dns-configuration-for-no-ip-com-with-ddclient-cb7c038a74be\n","date":1532098800,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1560783600,"objectID":"00f6ce3e4623d47f017231f47adc1b7f","permalink":"https://nobuto-m.github.io/post/2018/minimal-dynamic-dns-configuration-for-no-ip.com-with-ddclient/","publishdate":"2018-07-21T00:00:00+09:00","relpermalink":"/post/2018/minimal-dynamic-dns-configuration-for-no-ip.com-with-ddclient/","section":"post","summary":"EDIT: I have migrated one of my domains to Google Domains so I’m using protocol=googledomains these days. When I searched for a way to configure ddclient for No-IP.com, some pages mention protocol=dyndns2 with a custom URL.","tags":["planet-ubuntu"],"title":"Minimal Dynamic DNS configuration for No-IP.com with ddclient","type":"post"},{"authors":[],"categories":["Ubuntu"],"content":"With Livepatch support in Linux kernel and Livepatch service for Ubuntu, reboots are no longer necessary even when kernel vulnerabilities are found. You can avoid and postpone unplanned reboots to whenever convenient for you, such as scheduled maintenance windows (Well, there are some corner cases which still require reboots though).\nWhat about services? After applying security updates of libraries, some services still grab old libraries which may have vulnerabilities. You can list up those processes with “lsof”.\n$ sudo lsof / | egrep -w \u0026#39;DEL|deleted\u0026#39; ... apache2 2296 root DEL REG 252,0 260616 /lib/x86_64-linux-gnu/libcrypto.so.1.0.0 apache2 2296 root DEL REG 252,0 260711 /lib/x86_64-linux-gnu/libssl.so.1.0.0 apache2 2299 www-data DEL REG 252,0 260616 /lib/x86_64-linux-gnu/libcrypto.so.1.0.0 apache2 2299 www-data DEL REG 252,0 260711 /lib/x86_64-linux-gnu/libssl.so.1.0.0 ... With “lsof”, you have to determine which process belongs to which systemd unit and manually restart those units. There is a helper script called “needrestart”. It is inspired by checkrestart from the debian-goodies package according to their doc. It shows a handy dialogue at the end of apt upgrade and prompts service restarts.\nTo use “needrestart”, you just need to install a package with the same name.\n$ sudo apt install needrestart You can also change the default behavior by editing /etc/needrestart/needrestart.conf. For example, you can enable automatic restart without asking.\n# Restart services (l)ist only, (i)nteractive or (a)utomatically. #$nrconf{restart} = \u0026#39;i\u0026#39;; Furthermore, it has “nagios” plugin mode(-p) so that it can be integrated with monitoring systems. With this mode, you might want to skip an obsolete kernel check by adding -l flag if kernel patching is managed by Livepatch.\n$ sudo needrestart -p -l CRIT — Services: 4 (!), Containers: none, Sessions: 1 (!)|Services=4;;0;0 Containers=0;;0;0 Sessions=1;0;;0 Here is an example of Nagios status output.\nThis post was originally published at https://medium.com/@nobuto_m/knowing-what-services-need-restart-with-needrestart-37419f44ed46\n","date":1499094000,"expirydate":-62135596800,"kind":"page","lang":"en","lastmod":1499094000,"objectID":"94efc66abdbea2e1248661b51065423f","permalink":"https://nobuto-m.github.io/post/2017/knowing-what-services-need-restart-with-needrestart/","publishdate":"2017-07-04T00:00:00+09:00","relpermalink":"/post/2017/knowing-what-services-need-restart-with-needrestart/","section":"post","summary":"With Livepatch support in Linux kernel and Livepatch service for Ubuntu, reboots are no longer necessary even when kernel vulnerabilities are found. You can avoid and postpone unplanned reboots to whenever convenient for you, such as scheduled maintenance windows (Well, there are some corner cases which still require reboots though).","tags":["planet-ubuntu"],"title":"Knowing what services need restart with “needrestart”","type":"post"}]